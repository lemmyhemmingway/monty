<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monty Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        form { margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .uptime { font-weight: bold; }
        .uptime.high { color: green; }
        .uptime.medium { color: orange; }
        .uptime.low { color: red; }
        .ssl-fields, .dns-fields, .tcp-fields { display: none; }
        .check-type-ssl:checked ~ .ssl-fields { display: block; }
        .check-type-dns:checked ~ .dns-fields { display: block; }
        .check-type-tcp:checked ~ .tcp-fields { display: block; }
    </style>
</head>
<body>
    <h1>Monty Health Monitoring Dashboard</h1>

    <h2>Add New Endpoint</h2>
    <form id="endpoint-form">
        <label>URL: <input type="text" name="url" required></label><br>
        <label>Check Type:
            <input type="radio" name="check_type" value="http" checked> HTTP
            <input type="radio" name="check_type" value="ssl" class="check-type"> SSL
            <input type="radio" name="check_type" value="dns" class="check-type"> DNS
            <input type="radio" name="check_type" value="ping" class="check-type"> Ping
            <input type="radio" name="check_type" value="tcp" class="check-type"> TCP
        </label><br>
        <label>Interval (seconds): <input type="number" name="interval" value="60" required></label><br>
        <label>Timeout (seconds): <input type="number" name="timeout" value="30"></label><br>

        <div class="http-fields">
            <label>Expected Status Codes (comma separated): <input type="text" name="expected_status_codes" value="200,201,202,203,204,205,206,207,208,226,300,301,302,303,304,305,307,308"></label><br>
            <label>Max Response Time (ms): <input type="number" name="max_response_time" value="5000"></label><br>
        </div>

        <div class="ssl-fields">
        <label>Min Days Valid: <input type="number" name="min_days_valid" value="30"></label><br>
        <label>Check Chain: <input type="checkbox" name="check_chain" checked></label><br>
        <label>Check Domain Match: <input type="checkbox" name="check_domain_match" checked></label><br>
        <label>Acceptable TLS Versions (comma separated): <input type="text" name="acceptable_tls_versions" value="TLS 1.2,TLS 1.3"></label><br>
        </div>

        <div class="dns-fields">
            <label>DNS Record Type: <select name="dns_record_type">
                <option value="A">A</option>
                <option value="AAAA">AAAA</option>
                <option value="CNAME">CNAME</option>
                <option value="MX">MX</option>
                <option value="TXT">TXT</option>
            </select></label><br>
            <label>Expected DNS Answers (minimum): <input type="number" name="expected_dns_answers" value="1"></label><br>
        </div>

        <div class="tcp-fields">
            <label>TCP Port: <input type="number" name="tcp_port" value="80"></label><br>
        </div>

        <button type="submit">Add Endpoint</button>
    </form>

    <h2>Endpoints</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>URL</th>
                <th>Type</th>
                <th>Interval</th>
                <th>Uptime</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .endpoints}}
            <tr>
                <td>{{.ID}}</td>
                <td>{{.URL}}</td>
                <td>{{.CheckType}}</td>
                <td>{{.Interval}}s</td>
                <td class="uptime {{if ge .Uptime 95.0}}high{{else if ge .Uptime 80.0}}medium{{else}}low{{end}}">
                    {{printf "%.1f" .Uptime}}%
                </td>
                <td>
                {{if eq .CheckType "http"}}
                <a href="/endpoints/{{.ID}}/statuses">Statuses</a>
                {{else if eq .CheckType "ssl"}}
                <a href="/endpoints/{{.ID}}/ssl-statuses">SSL Statuses</a>
                {{else}}
                    <a href="/endpoints/{{.ID}}/statuses">Statuses</a>
                     {{end}}
                     <button onclick="deleteEndpoint('{{.ID}}')" style="margin-left: 10px; color: red;">Delete</button>
                 </td>
            </tr>
            {{end}}
        </tbody>
    </table>

    <script>
        // Toggle fields based on check type
        document.querySelectorAll('input[name="check_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
        const sslFields = document.querySelector('.ssl-fields');
        const dnsFields = document.querySelector('.dns-fields');
        const tcpFields = document.querySelector('.tcp-fields');
        const httpFields = document.querySelector('.http-fields');

        // Hide all fields first
        sslFields.style.display = 'none';
        dnsFields.style.display = 'none';
        tcpFields.style.display = 'none';
            httpFields.style.display = 'none';

                // Show relevant fields
                switch (this.value) {
                    case 'ssl':
                        sslFields.style.display = 'block';
                        break;
                    case 'dns':
                        dnsFields.style.display = 'block';
                        break;
                    case 'tcp':
                        tcpFields.style.display = 'block';
                        break;
                    case 'http':
                    default:
                        httpFields.style.display = 'block';
                        break;
                }
            });
        });

        // Submit form as JSON
        document.getElementById('endpoint-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = {};

            for (let [key, value] of formData) {
            if (key === 'expected_status_codes' || key === 'acceptable_tls_versions') {
            data[key] = value.split(',').map(s => s.trim()).filter(s => s).map(s => key === 'expected_status_codes' ? parseInt(s) : s);
            } else if (key === 'expected_dns_answers') {
            data[key] = [parseInt(value)]; // ExpectedDNSAnswers is an array
            } else if (key === 'interval' || key === 'timeout' || key === 'max_response_time' || key === 'min_days_valid' || key === 'tcp_port') {
            data[key] = parseInt(value);
            } else if (key === 'check_chain' || key === 'check_domain_match') {
            data[key] = this.querySelector(`input[name="${key}"]`).checked;
            } else {
                    data[key] = value;
                }
            }

            fetch('/endpoints', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Endpoint added successfully!');
                    location.reload();
                }
            })
            .catch(error => {
                alert('Error adding endpoint: ' + error);
            });
        });

        // Delete endpoint function
        function deleteEndpoint(id) {
            if (!confirm('Are you sure you want to delete this endpoint? This action cannot be undone.')) {
                return;
            }

            fetch(`/endpoints/${id}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Endpoint deleted successfully!');
                    location.reload();
                }
            })
            .catch(error => {
                alert('Error deleting endpoint: ' + error);
            });
        }
    </script>
</body>
</html>
